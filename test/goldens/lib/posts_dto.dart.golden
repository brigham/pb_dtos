import 'package:freezed_annotation/freezed_annotation.dart';
import 'package:json_annotation/json_annotation.dart';
import "package:pocketbase/pocketbase.dart" show RecordModel;
import 'package:pb_dtos/pb/dto/dto.dart';
import 'package:pb_dtos/pb/dto/dto_expand.dart';
import 'package:pb_dtos/pb/dto/dto_field.dart';
import 'package:pb_dtos/pb/dto/file_dto.dart';
import 'package:pb_dtos/pb/dto/filter_expression.dart';
import 'package:pb_dtos/pb/dto/geopoint_dto.dart';
import 'package:pb_dtos/pb/dto/relation_dto.dart';
import 'package:pb_dtos/pb/dto/patch_dto.dart';
import 'users_dto.dart';
import 'permissions_dto.dart';
import 'roles_dto.dart';
import 'follows_dto.dart';
import 'friends_dto.dart';
import 'blocks_dto.dart';
import 'posts_dto.dart';
import 'private_profiles_dto.dart';
import 'posts_dto_field_select.dart';
import 'posts_dto_filter.dart';
import 'posts_dto_meta.dart';
import 'posts_dto_sort.dart';
import 'posts_patch_dto.dart';
import 'posts_dto_expand.dart';
import 'package:http/http.dart' as http;

part 'posts_dto.freezed.dart';
part 'posts_dto.g.dart';

enum PostsVisibilityEnum {
  public("public"),
  private("private"),
  friends("friends"),
  $unset("");

  final String value;
  const PostsVisibilityEnum(this.value);
  @override
  String toString() => this.value;
}

enum PostsDtoFieldEnum<V, A> implements DtoTypedField<PostsDto, V, A> {
  poster<RelationDto<UsersDto>, RelationDto<UsersDto>>(
    'poster',
    const DtoRelationFieldSettings(
      required: true,
      collectionId: "_pb_users_auth_",
      cascadeDelete: false,
      minSelect: 1,
      maxSelect: 1,
    ),
  ),
  message<String, String>(
    'message',
    const DtoEditorFieldSettings(
      required: true,
      maxSize: 0,
      convertURLs: false,
    ),
  ),
  photo<FileDto, FileDto?>(
    'photo',
    const DtoFileFieldSettings(
      required: false,
      maxSize: 5242880,
      maxSelect: 1,
      mimeTypes: ["image/jpeg", "image/png", "image/gif", "image/webp"],
      thumbs: ["50x50", "150x150"],
      protected: false,
    ),
  ),
  link<String, String>(
    'link',
    const DtoURLFieldSettings(
      required: false,
      exceptDomains: [],
      onlyDomains: [],
    ),
  ),
  location<GeopointDto, GeopointDto>(
    'location',
    const DtoGeoPointFieldSettings(required: false),
  ),
  reviewStars<num, num>(
    'review_stars',
    const DtoNumberFieldSettings(
      required: false,
      min: 0,
      max: 5,
      onlyInt: false,
    ),
  ),
  tagged<RelationDto<UsersDto>, List<RelationDto<UsersDto>>>(
    'tagged',
    const DtoRelationFieldSettings(
      required: false,
      collectionId: "_pb_users_auth_",
      cascadeDelete: false,
      minSelect: 0,
      maxSelect: 999,
    ),
  ),
  draft<bool, bool>('draft', const DtoBoolFieldSettings(required: false)),
  scheduled<DateTime, DateTime?>(
    'scheduled',
    const DtoDateFieldSettings(required: false, min: null, max: null),
  ),
  visibility<PostsVisibilityEnum, PostsVisibilityEnum?>(
    'visibility',
    const DtoSelectFieldSettings(
      required: false,
      values: ["public", "private", "friends"],
      maxSelect: 0,
    ),
  ),
  created<DateTime, DateTime?>(
    'created',
    const DtoAutodateFieldSettings(onCreate: true, onUpdate: false),
  ),
  metadata<dynamic, dynamic>(
    'metadata',
    const DtoJSONFieldSettings(required: false, maxSize: 0),
  ),
  id<String, String>(
    'id',
    const DtoTextFieldSettings(
      required: true,
      autogeneratePattern: "[a-z0-9]{15}",
      min: 15,
      max: 15,
      pattern: r"^[a-z0-9]+$",
    ),
  );

  const PostsDtoFieldEnum(this.pbName, this.settings);

  @override
  A get(PostsDto dto) {
    switch (this) {
      case .poster:
        return dto.poster as A;
      case .message:
        return dto.message as A;
      case .photo:
        return dto.photo as A;
      case .link:
        return dto.link as A;
      case .location:
        return dto.location as A;
      case .reviewStars:
        return dto.reviewStars as A;
      case .tagged:
        return dto.tagged as A;
      case .draft:
        return dto.draft as A;
      case .scheduled:
        return dto.scheduled as A;
      case .visibility:
        return dto.visibility as A;
      case .created:
        return dto.created as A;
      case .metadata:
        return dto.metadata as A;
      case .id:
        return dto.id as A;
    }
  }

  @override
  PostsDto copyWith(PostsDto dto, A value) {
    switch (this) {
      case .poster:
        return dto.copyWith(poster: value as RelationDto<UsersDto>);
      case .message:
        return dto.copyWith(message: value as String);
      case .photo:
        return dto.copyWith(photo: value as FileDto?);
      case .link:
        return dto.copyWith(link: value as String);
      case .location:
        return dto.copyWith(location: value as GeopointDto);
      case .reviewStars:
        return dto.copyWith(reviewStars: value as num);
      case .tagged:
        return dto.copyWith(tagged: value as List<RelationDto<UsersDto>>);
      case .draft:
        return dto.copyWith(draft: value as bool);
      case .scheduled:
        return dto.copyWith(scheduled: value as DateTime?);
      case .visibility:
        return dto.copyWith(visibility: value as PostsVisibilityEnum?);
      case .created:
        return dto.copyWith(created: value as DateTime?);
      case .metadata:
        return dto.copyWith(metadata: value as dynamic);
      case .id:
        return dto.copyWith(id: value as String);
    }
  }

  @override
  final String pbName;

  @override
  final DtoFieldSettings settings;
}

@freezed
@JsonSerializable(explicitToJson: true, includeIfNull: false)
class PostsDto with _$PostsDto implements Dto<PostsDto> {
  static PostsDtoMeta meta() => const PostsDtoMeta();

  static PostsDtoSort<PostsDto> sort(
    void Function(PostsDtoSort<PostsDto>) builder,
  ) {
    var sort = PostsDtoSort<PostsDto>();
    builder(sort);
    return sort;
  }

  static PostsDtoFilter filter(void Function(PostsDtoFilter) builder) {
    var filter = PostsDtoFilter();
    builder(filter);
    return filter;
  }

  static PostsPatchDto patch(void Function(PostsPatchDto) builder) {
    var patch = PostsPatchDto();
    builder(patch);
    return patch;
  }

  @override
  PostsPatchDto asPatch() => PostsPatchDto()
    ..poster = poster
    ..message = message
    ..photo = photo
    ..link = link
    ..location = location
    ..reviewStars = reviewStars
    ..tagged = tagged
    ..draft = draft
    ..scheduled = scheduled
    ..visibility = visibility
    ..metadata = metadata;

  @override
  PostsPatchDto diff(PostsDto newValue) => PostsPatchDto()
    ..poster = poster != newValue.poster ? newValue.poster : null
    ..message = message != newValue.message ? newValue.message : null
    ..photo = photo != newValue.photo ? newValue.photo : null
    ..link = link != newValue.link ? newValue.link : null
    ..location = location != newValue.location ? newValue.location : null
    ..reviewStars = reviewStars != newValue.reviewStars
        ? newValue.reviewStars
        : null
    ..tagged = tagged != newValue.tagged ? newValue.tagged : null
    ..draft = draft != newValue.draft ? newValue.draft : null
    ..scheduled = scheduled != newValue.scheduled ? newValue.scheduled : null
    ..visibility = visibility != newValue.visibility
        ? newValue.visibility
        : null
    ..metadata = metadata != newValue.metadata ? newValue.metadata : null;

  static PostsDtoExpand<PostsDto> expansions(
    void Function(PostsDtoExpand) builder,
  ) {
    var expansions = PostsDtoExpand<PostsDto>();
    builder(expansions);
    return expansions;
  }

  static PostsDtoFieldSelect<PostsDto> fields(
    void Function(PostsDtoFieldSelect<PostsDto>) builder,
  ) {
    var select = PostsDtoFieldSelect<PostsDto>();
    builder(select);
    return select;
  }

  PostsDto({
    this.poster = const RelationDto<UsersDto>(""),
    required this.message,
    this.photo = null,
    this.link = "",
    this.location = const GeopointDto(lat: 0, lon: 0),
    this.reviewStars = 0,
    this.tagged = const [],
    this.draft = false,
    this.scheduled = null,
    this.visibility = null,
    this.created = null,
    this.metadata = null,
    this.id = "",
    this.expand,
  });

  @override
  final RelationDto<UsersDto> poster;
  @JsonKey(toJson: Dto.optionalStringToJson, defaultValue: "")
  @override
  final String message;
  @override
  final FileDto? photo;
  @JsonKey(toJson: Dto.optionalStringToJson)
  @override
  final String link;
  @override
  final GeopointDto location;
  @JsonKey(name: 'review_stars', toJson: Dto.optionalNumToJson)
  @override
  final num reviewStars;
  @override
  final List<RelationDto<UsersDto>> tagged;
  @JsonKey(toJson: Dto.optionalBoolToJson)
  @override
  final bool draft;
  @override
  final DateTime? scheduled;
  @JsonKey(unknownEnumValue: PostsVisibilityEnum?.$unset)
  @override
  final PostsVisibilityEnum? visibility;
  @override
  final DateTime? created;
  @override
  final dynamic metadata;
  @JsonKey(toJson: Dto.optionalStringToJson)
  @override
  final String id;
  @JsonKey(includeToJson: false)
  @override
  final PostsExpandDto? expand;

  factory PostsDto.fromRecord(RecordModel record) =>
      PostsDto.fromJson(record.toJson());

  factory PostsDto.fromJson(Map<String, dynamic> json) =>
      _$PostsDtoFromJson(json);

  @override
  Map<String, dynamic> toJson() => _$PostsDtoToJson(this);

  @override
  List<Future<http.MultipartFile>> toFiles() =>
      [photo?.toFile('photo')].whereType<Future<http.MultipartFile>>().toList();

  @override
  RelationDto<PostsDto> asRelation() => RelationDto(id);
}
